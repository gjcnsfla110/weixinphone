{"version":3,"file":"mainData.js","sources":["stores/mainData.js"],"sourcesContent":["import { defineStore } from \"pinia\";\nimport { serviceGet,servicePost } from \"@/utill/request\";\nimport { resultPage,listTrees } from \"@/utill/common\";\nimport { ref } from \"vue\";\n\nexport const useMainStores = defineStore('mainData',{\n\tstate:()=>({\n\t\tmain: ref([]),\n\t\tiphone: ref([]),\n\t\tsamsung: ref([]),\n\t\tsubMenu: ref([]),\n\t\tgoodsSpecs: ref([]),\n\t\tcategoryMenu: ref([]),\n\t\tcategorySubmenu: ref([]),\n\t\taccessoriesCategory:ref([]),\n\t\taccessoriesSubCategory:ref([]),\n\t\tisLoading: ref(false),\n\t\tisDataReady: ref(false),\n\t}),\n\tgetters:{\n\t\tisDataAvailable: (state) => state.isDataReady && !state.isLoading,\n\t},\n\tactions:{\n\t\t// onLaunch에서 호출: 서버에서 데이터 가져와 스토어와 스토리지 업데이트\n\t\tasync fetchFromServer() {\n\t\t\tthis.isLoading = true;\n\t\t\ttry {\n\t\t\t\t// 캐시 확인\n\t\t\t\tconst cachedData = uni.getStorageSync('mainData');\n\t\t\t\tconst now = Date.now();\n\t\t\t\tif (cachedData && cachedData.expiry > now) {\n\t\t\t\t    this.main = cachedData.main || [];\n\t\t\t\t    this.iphone = cachedData.iphone || [];\n\t\t\t\t    this.samsung = cachedData.samsung || [];\n\t\t\t\t    this.subMenu = cachedData.subMenu || [];\n\t\t\t\t\tthis.goodsSpecs = cachedData.goodsSpecs || [];\n\t\t\t\t\tthis.categoryMenu = cachedData.categoryMenu || [];\n\t\t\t\t\tthis.categorySubmenu = cachedData.categorySubmenu || [];\n\t\t\t\t\tthis.accessoriesCategory = cachedData.accessoriesCategory || [];\n\t\t\t\t\tthis.accessoriesSubCategory = cachedData.accessoriesSubCategory || [];\n\t\t\t\t    this.isDataReady = true;\n\t\t\t\t    this.isLoading = false;\n\t\t\t\t    return;\n\t\t\t\t}\n\t\t\t\t// 캐시가 없거나 만료되었으면 서버 요청\n\t\t\t\tconst res = await serviceGet('app/index/main');\n\t\t\t\tconst newData = {\n\t\t\t\tsubMenu: res.subMenus || [],\n\t\t\t\tgoodsSpecs: res.goodsSpecs || [],\n\t\t\t\tcategoryMenu : res.categoryMenu || [],\n\t\t\t\tcategorySubmenu : res.categorySubmenu || [],\n\t\t\t\taccessoriesCategory : res.accessoriesCategory || [],\n\t\t\t\taccessoriesSubCategory : res.accessoriesSubCategory || [],\n\t\t\t\tmain: [],\n\t\t\t\tiphone: [],\n\t\t\t\tsamsung: [],\n\t\t\t\t};\n\n\t\t\t\t// 페이지 데이터 처리\n\t\t\t\tlet pages = res.pages || [];\n\t\t\t\tlet components = res.components || [];\n\t\t\t\tlet componentItems = res.componentItems || [];\n\t\t\t\tlet componentBanners = res.componentBanners || [];\n\t\t\t\tpages = resultPage(pages, components, componentItems, componentBanners);\n\n\t\t\t\tnewData.main = pages.filter(item => item.page_key === 'main') || [];\n\t\t\t\tnewData.iphone = pages.filter(item => item.page_key === 'iphone') || [];\n\t\t\t\tnewData.samsung = pages.filter(item => item.page_key === 'samsung') || [];\n\n\t\t\t\t// 스토어 업데이트\n\t\t\t\tthis.main = newData.main;\n\t\t\t\tthis.iphone = newData.iphone;\n\t\t\t\tthis.samsung = newData.samsung;\n\t\t\t\tthis.subMenu = newData.subMenu;\n\t\t\t\tthis.goodsSpecs = newData.goodsSpecs;\n\t\t\t\tthis.categoryMenu = listTrees(newData.categoryMenu,'category_id');\n\t\t\t\tthis.categorySubmenu = newData.categorySubmenu;\n\t\t\t\tthis.accessoriesCategory = listTrees(newData.accessoriesCategory);\n\t\t\t\tthis.accessoriesSubCategory = newData.accessoriesSubCategory;\n\t\t\t\tthis.isDataReady = true;\n\n\t\t\t\t// 캐시에 저장 (만료 시간: 24시간)\n\t\t\t\tconst nowStrogeTime = Date.now();\n\t\t\t\tconst expiry = nowStrogeTime + 24 * 60 * 60 * 1000; // 24시간 후\n\t\t\t\tuni.setStorageSync('mainData', {\n\t\t\t\tmain: this.main,\n\t\t\t\tiphone: this.iphone,\n\t\t\t\tsamsung: this.samsung,\n\t\t\t\tsubMenu: this.subMenu,\n\t\t\t\tgoodsSpecs: this.goodsSpecs,\n\t\t\t\tcategoryMenu: this.categoryMenu,\n\t\t\t\tcategorySubmenu: this.categorySubmenu,\n\t\t\t\taccessoriesCategory: this.accessoriesCategory,\n\t\t\t\taccessoriesSubCategory: this.accessoriesSubCategory,\n\t\t\t\texpiry,\n\t\t\t\t});\n\n\t\t\t} catch (error) {\n\t\t\t\tconsole.log('Error fetching server data:', error);\n\t\t\t\t// 에러 발생 시 캐시 데이터 사용 (있을 경우)\n\t\t\t\tconst cachedData = uni.getStorageSync('mainData');\n\t\t\t\tif (cachedData && cachedData.expiry > Date.now()) {\n\t\t\t\tthis.main = cachedData.main || [];\n\t\t\t\tthis.iphone = cachedData.iphone || [];\n\t\t\t\tthis.samsung = cachedData.samsung || [];\n\t\t\t\tthis.subMenu = cachedData.subMenu || [];\n\t\t\t\tthis.categoryMenu = cachedData.categoryMenu || [];\n\t\t\t\tthis.categorySubmenu = cachedData.categorySubmenu || [];\n\t\t\t\tthis.accessoriesCategory = cachedData.accessoriesCategory || [];\n\t\t\t\tthis.accessoriesSubCategory = cachedData.accessoriesSubCategory || [];\n\t\t\t\tthis.isDataReady = true;\n\t\t\t\t}\n\t\t\t} finally {\n\t\t\t\tthis.isLoading = false;\n\t\t\t}\n\t\t},\n\n\t\tasync lodingMain(){\n\t\t\tawait this.fetchFromServer(); // loadingMain은 fetchFromServer 호출로 통합\n\t\t},\n\t\t// 캐시 삭제 메서드\n        clearCache() {\n            uni.removeStorageSync('mainData');\n            this.main = [];\n            this.iphone = [];\n            this.samsung = [];\n            this.subMenu = [];\n\t\t\tthis.goodsSpecs = [];\n\t\t\tthis.categoryMenu = [];\n\t\t\tthis.categorySubmenu = [];\n\t\t\tthis.accessoriesCategory = [];\n\t\t\tthis.accessoriesSubCategory=[];\n            this.isDataReady = false;\n        }\n\t}\n})"],"names":["defineStore","ref","uni","serviceGet","resultPage","listTrees"],"mappings":"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"}